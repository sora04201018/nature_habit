services:
  db:  # データベースの定義
    image: postgres:15  #postgreSQL version15を使う
    restart: always  #コンテナを常に再起動
    environment:  #環境設定
      TZ: Asia/Tokyo  # 東京時刻に設定
      POSTGRES_USER: postgres  # データベースユーザー名
      POSTGRES_PASSWORD: password  # データーベースパスワード
      POSTGRES_DB: nature_habit_development  # データベース名
    volumes:
      - postgresql_data:/var/lib/postgresql/data #データの永続化。コンテナを消してもデータが残るようにする。パスは公式イメージ。
    ports: # ポート設定
      - "5432:5432"
    healthcheck: # DBが使えるか確認
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  web: # Railsアプリの設定
    build:
      context: .
      dockerfile: Dockerfile.dev # 開発用のDockerfile.devを使用
    command: bash -c "bundle exec rails db:prepare && rm -f tmp/pids/server.pid && ./bin/dev"
    tty: true
    stdin_open: true
    volumes:
      - .:/app                        # ホストのコードをコンテナの /app に同期（編集即反映）
      - bundle_data:/usr/local/bundle # gem のキャッシュを共有して毎回の bundle install を速くする
      - node_modules:/app/node_modules # node_modules を分離してホストと衝突しないようにする
    environment:  # 環境設定
      TZ: Asia/Tokyo  # 東京時刻に合わせる
      DATABASE_URL: postgresql://postgres:password@db:5432/nature_habit_development
    ports:
      - "3000:3000"   # ブラウザで http://localhost:3000 を見るために開ける
    depends_on: # 健康チェックを通るのを待つ設定
      db:
        condition: service_healthy

volumes:
  bundle_data:
  postgresql_data:
  node_modules:
